<div class="section">
    <div>
        <mat-card>
            <div class="row form_head">
                <h3>PURCHASE ORDER</h3>
            </div>
            <div class="form_basic">
                <form class="form_set"
                    [formGroup]="prForm.get('selectedPRType')?.value === 'service'?createServiceForm:createPrForm">
                    <div class="row">
                        <div class="col-xxl-8 col-lg-8 col-md-8 col-sm-8 col-12">
                            <div class="row">
                                <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                                    <div class="form-group">
                                        <mat-form-field appearance="outline">
                                            <mat-label>Branch Name</mat-label>
                                            <input matInput type="text" formControlName="branchName" readonly />
                                        </mat-form-field>
                                    </div>
                                </div>
                                <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                                    <div class="form-group">
                                        <mat-form-field appearance="outline">
                                            <mat-label>Branch Code</mat-label>
                                            <input matInput type="text" formControlName="branchCode" readonly />
                                        </mat-form-field>
                                    </div>
                                </div>
                                <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                                    <div class="form-group">
                                        <mat-form-field appearance="outline">
                                            <mat-label>GST No</mat-label>
                                            <input matInput type="text" formControlName="gstNo" readonly />
                                        </mat-form-field>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="row">
                                    <div class="col-xxl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                        <div class="form-group">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Branch Address</mat-label>
                                                <input matInput type="text" formControlName="branchAddress" readonly />
                                            </mat-form-field>
                                        </div>
                                    </div>
                                    <div class="col-xxl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                        <div class="form-group">
                                            <mat-form-field appearance="outline">
                                                <mat-label>Delivery Branch</mat-label>
                                                <mat-select formControlName="delivery_branch">
                                                    <mat-option *ngFor="let data of branchList"
                                                        [value]="data.branch_name">{{data?.branch_name}}</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                    <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                                        <div class="form-group">
                                            <mat-form-field appearance="outline" readonly>
                                                <mat-label>DEPARTMENT</mat-label>
                                                <mat-select formControlName="department_name">
                                                    <mat-option *ngFor="let data of departmentList"
                                                        [value]="data.department_name">{{data?.department_name}}</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                    <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                                        <div class="form-group">
                                            <mat-form-field appearance="outline" readonly>
                                                <mat-label>PO Type</mat-label>
                                                <mat-select (selectionChange)="typeChange($event)"
                                                    formControlName="po_type">
                                                    <mat-option value="Capex">Capex</mat-option>
                                                    <mat-option value="Opex">Opex</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                    <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                                        <div class="form-group row">
                                            <mat-form-field appearance="outline" readonly>
                                                <mat-label>Financial Year</mat-label>
                                                <mat-select (selectionChange)="budget_details();" formControlName="financial_year">
                                                    <mat-option value="2025-2026">2025-2026</mat-option>
                                                    <mat-option value="2024-2025">2024-2025</mat-option>
                                                    <mat-option value="2023-2024">2023-2024</mat-option>
                                                    <mat-option value="2022-2023">2022-2023</mat-option>
                                                    <mat-option value="2021-2022">2021-2022</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                    <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                                        <div class="form-group">
                                            <mat-form-field appearance="outline" readonly>
                                                <mat-label>Supplier Name</mat-label>
                                                <mat-select formControlName="po_supplier_vendor_name">
                                                    <mat-option *ngFor="let data of vendorList"
                                                        [value]="data.vendor_name">{{data?.vendor_name}}</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                    <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                                        <div class="form-group">
                                            <mat-form-field appearance="outline" class="mt-1">
                                                <mat-label>PO Date</mat-label>
                                                <input readonly matInput [matDatepicker]="picker" format="DD-MM-YY"
                                                    formControlName="po_date" />
                                                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                                <mat-datepicker #picker></mat-datepicker>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                    <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                                        <div class="form-group">
                                            <mat-form-field appearance="outline" class="mt-1">
                                                <mat-label>PO No.</mat-label>
                                                <input readonly matInput formControlName="po_number" />
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" *ngIf="!id">
                                    <div class="col-xxl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                                        <!-- Radio buttons for Item PR and Service PO -->
                                        <form [formGroup]="prForm">
                                            <label class="me-5">
                                                <input type="radio" (click)="arayEmpty($event)"
                                                    formControlName="selectedPRType" value="item"> Item
                                                PO
                                            </label>
                                            <label class="me-5">
                                                <input type="radio" (click)="arayEmpty($event)"
                                                    formControlName="selectedPRType" value="service">
                                                Service PO
                                            </label>
                                        </form>
                                        <!-- Conditionally display buttons based on selectedPOType -->
                                    </div>
                                </div>
                                <div class="m-3">
                                    <button mat-raised-button color="primary" class="mx-3"
                                        *ngIf="prForm.get('selectedPRType')?.value === 'item'"
                                        (click)="addProduct($event)">
                                        + Add Item
                                    </button>
                                    <button mat-raised-button color="primary"
                                        *ngIf="prForm.get('selectedPRType')?.value === 'service'"
                                        (click)="addService($event)">
                                        + Add Services
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                            <div class="row">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th style="text-align: center;" colspan="2">Budget Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="text-align: center;">
                                            <td>
                                                <b>Session</b>
                                            </td>
                                            <td>
                                                {{financialYear}}
                                            </td>
                                        </tr>
                                        <tr style="text-align: center;">
                                            <td>
                                                <b>Budget Amount</b>
                                            </td>
                                            <td>
                                                {{budgetAmount}}
                                            </td>
                                        </tr>
                                        <tr style="text-align: center;">
                                            <td>
                                                <b>Total Purchase</b>
                                            </td>
                                            <td>
                                                {{dept_po}}
                                            </td>
                                        </tr>
                                        <tr style="text-align: center;">
                                            <td>
                                                <b>Remaining(Bud.)</b>
                                            </td>
                                            <td>
                                                {{remainingAmount}}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <br />
                    <!-- item type -->
                    <div class="row" *ngIf="prForm.get('selectedPRType')?.value === 'item'">
                        <div class="col-xxl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                            <div class="form_basic" style="overflow-x:auto;">
                                <table class="table table-bordered" style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th scope="col">Item Image</th>
                                            <th scope="col">Item Name</th>
                                            <th scope="col">Item Code</th>
                                            <th scope="col">Quantity</th>
                                            <th scope="col">Unit Price</th>
                                            <th scope="col">Amount</th>
                                            <th scope="col">Tax</th>
                                            <th *ngIf="!id" scope="col">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody formArrayName="item_detail"
                                        *ngFor="let control of CF_1.item_detail['controls']; index as i">
                                        <tr *ngIf="CF_1.item_detail.length !=0" style="text-align: center;"
                                            [formGroup]="control">
                                            <td>
                                                <div class="form-group">
                                                    <img [src]="control.value?.item_document" style="cursor: pointer;"
                                                        width="50" height="50"
                                                        (click)="seePreviewTable(control.value?.item_document)" />
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input matInput formControlName="item_name" readonly />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group ">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input matInput formControlName="item_code" readonly />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input type="number" matInput formControlName="item_quantity"
                                                            min="1" #box (keyup)="keyUpItem(box.value,i,control)" />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input type="number" matInput formControlName="unit_price"
                                                            min="1" #box1 (keyup)="keyUpItem(box1.value,i,control)" />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input readonly type="number" matInput formControlName="amount"
                                                            min="1" />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input type="number" matInput formControlName="tax" min="1" />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox" *ngIf="!id">
                                                <mat-icon (click)="deleteRow(i)">delete</mat-icon>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tbody *ngIf="CF_1.item_detail.length == 0">
                                        <tr>
                                            <td colspan="8" style="text-align: center;color: #8e8e8e">
                                                Product Not Selected
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="row" *ngIf="CF_1.item_detail.length !== 0">
                                    <div class="col-10">
                                        <p style="text-align: end; font-size: 16px; font-weight: 500;">Total = </p>
                                    </div>
                                    <div class="col-1">
                                        <p style="font-size: 16px; font-weight: 500;">{{totalAmountItem}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br />

                    <!-- service type -->
                    <div class="row" *ngIf="prForm.get('selectedPRType')?.value === 'service'">
                        <div class="col-xxl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                            <div class="form_basic" style="overflow-x:auto;">
                                <table class="table table-bordered" style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th scope="col">Service Image</th>
                                            <th scope="col">Service Name</th>
                                            <th scope="col">Service Code</th>
                                            <th scope="col">Quantity</th>
                                            <th scope="col">Unit Price</th>
                                            <th scope="col">Amount</th>
                                            <th scope="col">Tax</th>
                                            <th *ngIf="!id" scope="col">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody formArrayName="service_detail"
                                        *ngFor="let control of CF_2.service_detail['controls']; index as i">
                                        <tr *ngIf="CF_2.service_detail.length !=0" style="text-align: center;"
                                            [formGroup]="control">
                                            <td>
                                                <div class="form-group">
                                                    <img [src]="control.value?.service_document"
                                                        style="cursor: pointer;" width="50" height="50"
                                                        (click)="seePreviewTable(control.value?.service_document)" />
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input matInput formControlName="service_name" readonly />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group ">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input matInput formControlName="service_code" readonly />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input type="number" matInput formControlName="service_quantity"
                                                            min="1" #box (keyup)="keyUpService(box.value,i,control)" />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input type="number" matInput formControlName="unit_price"
                                                            min="1" #box1
                                                            (keyup)="keyUpService(box1.value,i,control)" />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input readonly type="number" matInput formControlName="amount"
                                                            min="1" />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox">
                                                <div class="form-group">
                                                    <mat-form-field appearance="outline" style="width: 10vw">
                                                        <input type="number" matInput formControlName="tax" min="1" />
                                                    </mat-form-field>
                                                </div>
                                            </td>
                                            <td class="inpBox" *ngIf="!id">
                                                <mat-icon (click)="deleteServiceRow(i)">delete</mat-icon>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tbody *ngIf="CF_2.service_detail.length == 0">
                                        <tr>
                                            <td colspan="8" style="text-align: center;color: #8e8e8e">
                                                Product Not Selected
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="row" *ngIf="CF_2.service_detail.length !== 0">
                                    <div class="col-10">
                                        <p style="text-align: end; font-size: 16px;
                    font-weight: 500;">Total = </p>
                                    </div>
                                    <div class="col-1">
                                        <p style="font-size: 16px;
                    font-weight: 500;">{{totalAmountService}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br />

                    <p style="font-weight: bold">Remarks :</p>
                    <div class="row">
                        <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                            <div class="form-group">
                                <mat-form-field appearance="outline">
                                    <mat-label>Remark</mat-label>
                                    <input matInput type="text" formControlName="po_remark" />
                                    <mat-error *ngIf="
                    createServiceForm.controls['po_remark'].hasError('required')
                ">
                                        This field is required!
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="col-xxl-4 col-lg-4 col-md-4 col-sm-4 col-12">
                            <div class="form-group">
                                <input class="form-control" type="file" style="padding-right: 19%"
                                    title="UPLOAD DOCUMENT" (change)="onChange($event)"
                                    formControlName="po_attached_doc" />
                                <img [src]="imagePath?imagePath:this.singlePrData?.po_attached_doc"
                                    *ngIf="imagePath || this.singlePrData?.po_attached_doc" class="imgEmp"
                                    (click)="seePreview(this.singlePrData?.po_attached_doc, imagePath)" />
                            </div>
                            <div *ngIf="createPrForm.controls['po_attached_doc']" class="invalid-feedback">
                                file is required
                            </div>
                        </div>
                    </div>

                    <div class="mt-3" align="end">
                        <button *ngIf="!id && !status " mat-raised-button color="primary" class="mx-3"
                            (click)="onSubmit()">
                            Submit
                        </button>
                        <!-- <button *ngIf="id && !status" mat-raised-button color="primary" class="mx-3"
                            (click)="onUpdate()">
                            Update
                        </button> -->
                        <button *ngIf="id && status" mat-raised-button color="primary" class="mx-3"
                            (click)="addRemark($event)">
                            Process to Approval
                        </button>
                        <button mat-raised-button color="warn" routerLink="../billing-branch-list">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </mat-card>
    </div>
</div>


<ng-template #callAPIDialog>
    <h2 matDialogTitle>Budget Reminder!</h2>
    <hr>
    <mat-dialog-content class="mat-typography">
        <div class="warning-msg">
            <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
            Out of Budget.
        </div>
        <h4 class="mt-4" style="font-weight: 700;">
            NOTE :- The amount of your current budget is {{budgetAmount}}, and this PO value is {{totalPRValue}}. This
            PO
            cannot be
            raised, thus send it to the RBH for budget approval.
        </h4>
    </mat-dialog-content>
    <hr>
    <mat-dialog-actions align="end">
        <!-- <button mat-button >Cancel</button>
        <button mat-button >Send for Approval</button> -->
        <button type="button" matDialogClose="no" class="btn btn-danger mx-4">Cancel</button>
        <button type="button" matDialogClose="yes" class="btn btn-primary">Send for Approval</button>
    </mat-dialog-actions>
</ng-template>